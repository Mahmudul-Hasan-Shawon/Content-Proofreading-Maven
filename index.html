<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXC Content Optimizer</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/10528/10528411.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        emerald: {
                            450: '#10b981',
                        },
                        teal: {
                            500: '#14b8a6',
                            600: '#0d9488',
                        },
                        purple: {
                            500: '#a855f7',
                            600: '#9333ea',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['SF Mono', 'Monaco', 'Courier New', 'monospace'],
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* --- Global Smooth Transitions --- */
        body,
        div,
        span,
        p,
        h1,
        h2,
        h3,
        button,
        input,
        .container-card {
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        /* Dark Mode overrides */
        .dark body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        /* --- Components --- */
        .container-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .dark .container-card {
            background: rgba(30, 41, 59, 0.7);
            border-color: #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .container-card:hover {
            border-color: #cbd5e1;
        }

        .dark .container-card:hover {
            border-color: #475569;
        }

        /* --- Tabs --- */
        .prompt-tab {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .prompt-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #0d9488 100%);
            color: white;
        }

        /* --- Scrollbar --- */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- Pill Inputs --- */
        .pill-input-group {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            padding: 4px 4px 4px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .dark .pill-input-group {
            background: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }

        .pill-input-group:focus-within {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        .pill-input {
            background: transparent;
            border: none;
            outline: none;
            flex-grow: 1;
            font-size: 0.85rem;
            color: #1e293b;
            min-width: 80px;
        }

        .dark .pill-input {
            color: #f1f5f9;
        }

        .pill-input::placeholder {
            color: #94a3b8;
        }

        .pill-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #64748b;
            transition: 0.3s ease-in-out;
        }

        .dark .pill-btn {
            background: #334155;
            color: #94a3b8;
        }

        .pill-btn:hover {
            background: #10b981;
            color: white;
        }

        .pill-btn.active {
            background: #10b981;
            color: white;
        }

        /* --- Brand/Status Icons --- */
        .status-icon-box {
            transition: transform 0.3s ease;
        }

        .container-card:hover .status-icon-box {
            transform: scale(1.1);
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* HIGHLIGHTS */
        .keyword-highlight {
            background: rgba(251, 191, 36, 0.15);
            color: #d97706;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .dark .keyword-highlight {
            background: rgba(217, 119, 6, 0.2);
            color: #fcd34d;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .h1-highlight {
            background: rgba(99, 102, 241, 0.15);
            color: #4f46e5;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .dark .h1-highlight {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            border-color: rgba(99, 102, 241, 0.3);
        }

        .topic-highlight {
            background: rgba(236, 72, 153, 0.15);
            color: #db2777;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(236, 72, 153, 0.2);
        }

        .dark .topic-highlight {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
            border-color: rgba(236, 72, 153, 0.3);
        }

        /* --- Upload Area --- */
        .upload-area {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .dark .upload-area {
            border-color: #334155;
            background: #1e293b;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .dark .upload-area:hover,
        .dark .upload-area.dragover {
            background: #0f2922;
            border-color: #5eead4;
        }

        /* Theme Spinner */
        .theme-icon-spin {
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .theme-btn:hover .theme-icon-spin {
            transform: rotate(180deg);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #10b981;
            color: #fff;
            text-align: center;
            border-radius: 16px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            top: 50px;
        }

        #toast.error {
            background-color: #ef4444;
        }

        /* --- Shared Parser Styles (Changes & CTA) --- */
        .parser-input-area {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            line-height: 1.5;
            resize: none;
        }

        .parser-card-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-left: 4px solid transparent;
        }

        .parser-card-item:hover {
            transform: translateX(4px);
        }

        /* Soft Red State for Fully Copied Card */
        .card-copied-fully {
            background-color: #fef2f2;
            /* red-50 */
            border-color: #fecaca;
            /* red-200 */
            border-left-color: #ef4444 !important;
        }

        .dark .card-copied-fully {
            background-color: rgba(153, 27, 27, 0.15);
            /* red-900/15 */
            border-color: rgba(239, 68, 68, 0.3);
            /* red-500/30 */
            border-left-color: #f87171 !important;
        }

        .card-copied-fully .card-text {
            color: #7f1d1d;
            /* red-900 */
        }

        .dark .card-copied-fully .card-text {
            color: #fca5a5;
            /* red-400 */
        }

        /* Progress Bar Styling */
        .btn-progress-container {
            position: relative;
            overflow: hidden;
        }

        .btn-progress-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: #10b981;
            width: 0%;
            transition: width 0.3s ease-out;
            border-radius: 99px;
        }

        .btn-icon {
            transition: opacity 0.2s;
        }

        .loading .btn-icon {
            opacity: 0;
        }
    </style>
</head>

<body class="antialiased min-h-screen">
    <div class="container mx-auto px-2 py-6 active max-w-7xl">
        <!-- Header -->
        <header class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4 animate-fade-in">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-green-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg shadow-green-500/30 transition-transform hover:rotate-3 hover:scale-110 cursor-pointer">
                    <i class="fas fa-wand-magic-sparkles text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">GXC Content Optimizer
                    </h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">Format prompts with precision &
                        brand rules</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Prompt Rules Button -->
                <button id="rules-btn" title="Prompt Instructions"
                    class="w-12 h-12 rounded-full bg-white dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 flex items-center justify-center transition-all hover:bg-blue-100 dark:hover:bg-blue-800/40 hover:scale-105 text-blue-600 dark:text-blue-400">
                    <i class="fas fa-book-open text-lg"></i>
                </button>

                <!-- GitHub Auto Load Button -->
                <button id="auto-load-btn" title="Load from GitHub"
                    class="w-12 h-12 rounded-full bg-white dark:bg-teal-900/20 border border-teal-200 dark:border-teal-800 flex items-center justify-center transition-all hover:bg-teal-100 dark:hover:bg-teal-800/40 hover:scale-105 text-teal-600 dark:text-teal-400 relative group">
                    <i class="fas fa-cloud-download-alt text-lg"></i>
                </button>

                <!-- Changes Parser Button -->
                <button id="changes-parser-btn" title="Changes Parser"
                    class="w-12 h-12 rounded-full bg-white dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 flex items-center justify-center transition-all hover:bg-purple-100 dark:hover:bg-purple-800/40 hover:scale-105 text-purple-600 dark:text-purple-400">
                    <i class="fas fa-columns text-lg"></i>
                </button>

                <!-- CTA Parser Button -->
                <button id="cta-parser-btn" title="CTA Parser"
                    class="w-12 h-12 rounded-full bg-white dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 flex items-center justify-center transition-all hover:bg-indigo-100 dark:hover:bg-indigo-800/40 hover:scale-105 text-indigo-600 dark:text-indigo-400">
                    <i class="fas fa-list-check text-lg"></i>
                </button>

                <!-- Theme Toggle -->
                <button id="theme-toggle"
                    class="theme-btn w-12 h-12 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex items-center justify-center shadow-lg transition-all hover:shadow-md">
                    <i id="theme-icon"
                        class="fas fa-moon text-gray-600 dark:text-yellow-400 text-lg theme-icon-spin"></i>
                </button>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

            <!-- Left Panel: Upload + Variables -->
            <div class="lg:col-span-3 flex flex-col gap-4 h-full">

                <div class="container-card p-5 flex flex-col">
                    <div class="upload-area p-8 text-center cursor-pointer rounded-xl group flex-grow flex flex-col justify-center"
                        id="upload-area">
                        <input type="file" id="file-input" accept=".txt" multiple class="hidden">
                        <div
                            class="w-16 h-16 bg-green-50 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4 transition-transform duration-300 group-hover:scale-110 group-hover:bg-green-100 dark:group-hover:bg-green-900/40">
                            <i class="fas fa-cloud-arrow-up text-green-500 dark:text-green-400 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-1">Drag & Drop</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">or click to browse .txt files</p>

                        <div
                            class="mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            <i class="fas fa-file-alt"></i> Brand + Prompts
                        </div>
                    </div>
                </div>

                <!-- Variables Bar -->
                <div class="container-card p-4 animate-fade-in flex flex-col gap-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sliders text-gray-400"></i>
                        <span
                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Variables</span>
                    </div>

                    <div class="flex flex-col gap-4">
                        <!-- Keyword Pill -->
                        <div>
                            <label for="pill-keyword"
                                class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1.5 ml-1">Keyword</label>
                            <div class="pill-input-group">
                                <input type="text" id="pill-keyword" class="pill-input"
                                    placeholder="e.g. Sustainable Coffee">
                                <button id="btn-keyword-apply" class="pill-btn" title="Apply Keyword">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Article Topic Pill -->
                        <div>
                            <label for="pill-topic"
                                class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1.5 ml-1">Article
                                Topic</label>
                            <div class="pill-input-group">
                                <input type="text" id="pill-topic" class="pill-input"
                                    placeholder="e.g. Green Energy Benefits">
                                <button id="btn-topic-apply" class="pill-btn" title="Apply Article Topic">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <!-- H1 Pill -->
                        <div>
                            <label for="pill-h1"
                                class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1.5 ml-1">H1
                                Heading</label>
                            <div class="pill-input-group">
                                <input type="text" id="pill-h1" class="pill-input"
                                    placeholder="e.g. The Future of Coffee">
                                <button id="btn-h1-apply" class="pill-btn" title="Apply H1">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Indicators Card -->
                <div class="container-card p-4 mt-auto">
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-transparent dark:border-gray-700/50 transition-all"
                            id="brand-row">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center status-icon-box">
                                    <i class="fas fa-book text-indigo-500 dark:text-indigo-400 text-xs"></i>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Brand
                                        Rules</span>
                                    <span class="status-text text-sm font-semibold text-gray-400">Missing</span>
                                </div>
                            </div>
                            <div id="brand-status-indicator" class="w-2 h-2 rounded-full bg-gray-300"></div>
                        </div>

                        <div class="flex items-center justify-between p-2 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-transparent dark:border-gray-700/50 transition-all"
                            id="prompts-row">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center status-icon-box">
                                    <i class="fas fa-layer-group text-emerald-500 dark:text-emerald-400 text-xs"></i>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Prompt
                                        Files</span>
                                    <span class="status-text text-sm font-semibold text-gray-400">0/7</span>
                                </div>
                            </div>
                            <div id="prompts-status-indicator" class="w-2 h-2 rounded-full bg-gray-300"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Tabs & Display -->
            <div class="lg:col-span-9 flex flex-col gap-4 h-full">

                <!-- Tabs Container -->
                <div class="container-card p-2 hidden" id="tabs-container">
                    <div class="flex overflow-x-auto custom-scrollbar gap-1 p-1" id="prompt-tabs-wrapper">
                        <!-- Tabs injected via JS -->
                    </div>
                </div>

                <!-- Main Display Card -->
                <div class="container-card flex-grow flex flex-col min-h-[600px] relative overflow-hidden">
                    <!-- Card Header -->
                    <div
                        class="px-6 py-4 border-b border-gray-100 dark:border-gray-700/50 flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm z-10">
                        <div class="min-w-0">
                            <h2 id="prompt-title"
                                class="font-bold text-gray-900 dark:text-white text-xl truncate transition-all duration-300">
                                Select a Prompt
                            </h2>
                            <p id="prompt-subtitle"
                                class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-1 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-300 dark:bg-gray-600"></span>
                                Waiting for files...
                            </p>
                        </div>

                        <div class="flex items-center gap-2">
                            <!-- Variable Active Indicators -->
                            <div id="badge-keyword"
                                class="hidden items-center gap-2 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-full text-xs font-bold border border-amber-200 dark:border-amber-800 transition-all">
                                <i class="fas fa-key"></i> <span>Keyword</span>
                            </div>
                            <div id="badge-h1"
                                class="hidden items-center gap-2 px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-full text-xs font-bold border border-indigo-200 dark:border-indigo-800 transition-all">
                                <i class="fas fa-heading"></i> <span>H1</span>
                            </div>
                            <div id="badge-topic"
                                class="hidden items-center gap-2 px-3 py-1.5 bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-400 rounded-full text-xs font-bold border border-pink-200 dark:border-pink-800 transition-all">
                                <i class="fas fa-newspaper"></i> <span>Topic</span>
                            </div>

                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                            <button id="copy-btn" disabled
                                class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-5 py-2 rounded-full text-sm font-semibold flex items-center gap-2 transition-all shadow-lg shadow-green-500/20 active:scale-95">
                                <i class="far fa-copy"></i> Copy Prompt
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="relative flex-grow bg-gray-50 dark:bg-[#0B1120] transition-colors duration-500">
                        <!-- Empty State -->
                        <div id="empty-state"
                            class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-20 transition-opacity duration-300">
                            <div
                                class="w-20 h-20 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center mb-6 transition-transform duration-500 hover:scale-110 hover:rotate-6">
                                <i class="fas fa-cube text-3xl text-gray-400 dark:text-gray-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-2">Workspace Empty</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-500 max-w-xs mx-auto">Drag & Drop your files
                                or click the Cloud icon in the header to auto-load from GitHub.</p>
                        </div>

                        <!-- Text Content -->
                        <div id="prompt-content-wrapper"
                            class="hidden h-full relative z-10 opacity-0 transition-opacity duration-300">
                            <div class="p-3 h-full overflow-y-auto custom-scrollbar">
                                <pre id="prompt-content"
                                    class="font-mono text-xs leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Rules Modal -->
    <div id="rules-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="rules-modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0"
            id="rules-modal-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-gray-200 dark:border-gray-700 scale-95 opacity-0"
                    id="rules-modal-panel">

                    <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div
                                class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-book-open text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white"
                                    id="rules-modal-title">Prompt Instructions</h3>
                                <div class="mt-4 space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">

                                    <!-- Rule 1 -->
                                    <div
                                        class="border-l-4 border-green-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 1:
                                            Introduction & Conclusion + Keyword Verification</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Prompt + Full content.</p>
                                    </div>

                                    <!-- Rule 2 -->
                                    <div
                                        class="border-l-4 border-blue-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 2:
                                            Heading Hierarchy + Keyword Optimization</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Just paste the 2nd Prompt
                                        </p>
                                    </div>

                                    <!-- Rule 3 -->
                                    <div
                                        class="border-l-4 border-purple-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 3:
                                            Section Formatting for Readability</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Take the 1st H2 up to the
                                            H2 immediately before the Conclusion (NB: final H2 is Conclusion).</p>
                                    </div>

                                    <!-- Rule 4 -->
                                    <div
                                        class="border-l-4 border-red-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 4:
                                            Redundancy Removal</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Prompt + Full content (Key
                                            Takeaways to FAQ)</p>
                                    </div>

                                    <!-- Rule 5 -->
                                    <div
                                        class="border-l-4 border-amber-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 5:
                                            FAQ Optimization (Featured Snippets)</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Prompt + ALL FAQs</p>
                                    </div>

                                    <!-- Rule 6 -->
                                    <div
                                        class="border-l-4 border-indigo-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 6:
                                            Meta Description Optimization</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Prompt + H1 to Conclusion,
                                            then copy optimized meta description and paste it into the sheet.</p>
                                    </div>

                                    <!-- Rule 7 -->
                                    <div
                                        class="border-l-4 border-pink-500 pl-4 py-2 rounded-r-md bg-gray-50 dark:bg-gray-900/50">
                                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-1">PROMPT 7:
                                            Generate Section CTAs</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400"> Prompt + Full content (Key
                                            Takeaways to FAQ)</p>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/30 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" id="rules-close-btn"
                            class="inline-flex w-full justify-center rounded-full bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">Got
                            it, thanks</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CTA Parser Modal (Redesigned Side-by-Side) -->
    <div id="cta-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0" id="cta-modal-backdrop">
        </div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <!-- Modal Panel -->
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-6xl border border-gray-200 dark:border-gray-700 scale-95 opacity-0"
                    id="cta-modal-panel">

                    <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4 h-[85vh] flex flex-col">
                        <div class="sm:flex sm:items-start mb-4 flex-shrink-0">
                            <div
                                class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/30 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-list-check text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                            <div
                                class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full flex justify-between items-center">
                                <div>
                                    <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white"
                                        id="modal-title">CTA Parser</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Extract bold text after
                                        "CTA:" marker.</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div id="cta-status"
                                        class="text-xs text-gray-600 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-xl">
                                        Ready
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content: Grid (Changes Parser Style) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow overflow-hidden mt-4">
                            <!-- Left: Input -->
                            <div class="flex flex-col h-full min-h-0">
                                <!-- Header: Left Side Text, Right Side Buttons -->
                                <div class="mb-2 mt-2 flex justify-between items-end">
                                    <div class="flex flex-col">
                                        <label
                                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Input
                                            Text</label>
                                        <span class="text-[10px] text-gray-400" id="cta-line-count">0 lines</span>
                                    </div>

                                    <!-- Top Right Actions -->
                                    <div class="flex gap-2">
                                        <button id="cta-reset-btn"
                                            class="px-3 py-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-400 text-xs font-medium rounded-xl transition flex items-center gap-1.5 transition-all duration-300 hover:shadow-lg hover:shadow-gray-500/25 hover:-translate-y-0.5 active:translate-y-0"
                                            title="Reset All">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <!-- <button id="cta-clear-btn"
                                            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-medium px-3 py-1.5 rounded-xl transition transition-all duration-300 hover:shadow-lg hover:shadow-gray-500/25 hover:-translate-y-0.5 active:translate-y-0"
                                            title="Clear Input">
                                            Clear
                                        </button> -->
                                        <button id="cta-process-btn"
                                            class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white text-sm font-medium px-4 py-1.5 rounded-xl shadow-lg transition-all flex items-center gap-2 transition-all duration-300 hover:shadow-lg hover:shadow-violet-500/25 hover:-translate-y-0.5 active:translate-y-0">
                                            <i class="fas fa-magic"></i> Parse
                                        </button>
                                    </div>
                                </div>

                                <div class="relative flex-grow">
                                    <textarea id="cta-input" rows="12"
                                        class="parser-input-area w-full h-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-0 focus:ring-indigo-400 focus:border-indigo-400 dark:bg-gray-900 dark:text-white transition resize-none custom-scrollbar"
                                        placeholder="Paste your text here..."></textarea>
                                </div>
                            </div>

                            <!-- Right: Output -->
                            <div
                                class="flex flex-col h-full min-h-0 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                                <!-- Header: Left Side Text/Count, Right Side Copy -->
                                <div
                                    class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 rounded-t-xl">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Parsed
                                            Results</span>
                                        <span id="cta-result-count"
                                            class="text-[10px] font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 px-2 py-0.5 rounded-md">0
                                            CTAs</span>
                                    </div>
                                    <button id="cta-copy-all-btn"
                                        class="hidden text-xs px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-sm flex items-center gap-2 btn-copy-progress transition-all duration-300 hover:shadow-lg hover:shadow-gray-500/25 hover:-translate-y-0.5 active:translate-y-0">
                                        <span>Copy All</span>
                                    </button>
                                </div>

                                <div id="cta-results-container"
                                    class="flex-grow overflow-y-auto p-4 custom-scrollbar space-y-3">
                                    <!-- Empty State -->
                                    <div id="cta-empty-state"
                                        class="h-full flex flex-col items-center justify-center text-center">
                                        <i class="fas fa-bullhorn text-4xl text-gray-300 dark:text-gray-700 mb-3"></i>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Extracted CTAs will appear
                                            here</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 sm:flex sm:flex-row-reverse sm:px-0 flex-shrink-0">
                            <button type="button" id="cta-close-btn"
                                class="inline-flex w-full justify-center rounded-full bg-gray-100 dark:bg-gray-700 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition sm:w-auto ">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Changes Parser Modal -->
    <div id="changes-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0"
            id="changes-modal-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <!-- Modal Panel -->
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-6xl border border-gray-200 dark:border-gray-700 scale-95 opacity-0"
                    id="changes-modal-panel">

                    <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4 h-[85vh] flex flex-col">
                        <div class="sm:flex sm:items-start mb-4 flex-shrink-0">
                            <div
                                class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/30 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-columns text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div
                                class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full flex justify-between items-center">
                                <div>
                                    <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white"
                                        id="modal-title">Changes Parser</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Extract changed headings
                                        from your text.</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div id="changes-status"
                                        class="text-xs text-gray-600 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-xl">
                                        Ready
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content: Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow overflow-hidden mt-4">
                            <!-- Left: Input -->
                            <div class="flex flex-col h-full min-h-0">
                                <!-- Header: Left Side Text, Right Side Buttons -->
                                <div class="mb-2 mt-2 flex justify-between items-end">
                                    <div class="flex flex-col">
                                        <label
                                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Input
                                            Text</label>
                                        <span class="text-[10px] text-gray-400" id="changes-line-count">0 lines</span>
                                    </div>

                                    <!-- Top Right Actions -->
                                    <div class="flex gap-2">
                                        <button id="changes-reset-btn"
                                            class="px-3 py-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-400 text-xs font-medium rounded-xl transition flex items-center gap-1.5 transition-all duration-300 hover:shadow-lg hover:shadow-gray-500/25 hover:-translate-y-0.5 active:translate-y-0"
                                            title="Reset All">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <!-- <button id="changes-clear-btn"
                                            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-medium px-3 py-1.5 rounded-xl transition transition-all duration-300 hover:shadow-lg hover:shadow-gray-500/25 hover:-translate-y-0.5 active:translate-y-0"
                                            title="Clear Input">
                                            Clear
                                        </button> -->
                                        <button id="changes-parse-btn"
                                            class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white text-sm font-medium px-4 py-1.5 rounded-xl shadow-lg transition-all flex items-center gap-2 transition-all duration-300 hover:shadow-lg hover:shadow-violet-500/25 hover:-translate-y-0.5 active:translate-y-0">
                                            <i class="fas fa-magic"></i> Parse
                                        </button>
                                    </div>
                                </div>

                                <div class="relative flex-grow">
                                    <textarea id="changes-input" rows="12"
                                        class="parser-input-area w-full h-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-0 focus:ring-purple-400 focus:border-purple-400 dark:bg-gray-900 dark:text-white transition resize-none custom-scrollbar"
                                        placeholder="Paste your text with CHANGED: format here..."></textarea>
                                </div>
                            </div>

                            <!-- Right: Output -->
                            <div
                                class="flex flex-col h-full min-h-0 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                                <!-- Header: Left Side Text/Count, Right Side Copy -->
                                <div
                                    class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 rounded-t-xl">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Parsed
                                            Results</span>
                                        <span id="changes-result-count"
                                            class="text-[10px] font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-0.5 rounded-md">0
                                            items</span>
                                    </div>
                                    <button id="changes-copy-all-btn"
                                        class="hidden text-xs px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-sm flex items-center gap-2 btn-copy-progress">
                                        <span>Copy All</span>
                                    </button>
                                </div>

                                <div id="changes-results-container"
                                    class="flex-grow overflow-y-auto p-4 custom-scrollbar space-y-3">
                                    <!-- Empty State -->
                                    <div id="changes-empty-state"
                                        class="h-full flex flex-col items-center justify-center text-center">
                                        <i class="fas fa-file-alt text-4xl text-gray-300 dark:text-gray-700 mb-3"></i>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Parsed changes will appear
                                            here</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 sm:flex sm:flex-row-reverse sm:px-0 flex-shrink-0">
                            <button type="button" id="changes-close-btn"
                                class="inline-flex w-full justify-center rounded-full bg-gray-100 dark:bg-gray-700 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition sm:w-auto">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">Demo content loaded successfully!</div>

    <script>
        // --- State Management ---
        const state = {
            brandRules: '',
            prompts: { 1: '', 2: '', 3: '', 4: '', 5: '', 6: '', 7: '' },
            promptTitles: {
                1: 'Intro & Conclusion',
                2: 'Heading',
                3: 'Section Formatting',
                4: 'Redundancy',
                5: 'FAQ',
                6: 'Meta Description',
                7: 'CTA'
            },
            variables: {
                keyword: '',
                h1: '',
                topic: ''
            },
            currentPromptIndex: 0,
            isDark: false,
            // Changes Parser State
            changesCopiedItems: {},
            // CTA Parser State
            ctaCopiedItems: {}
        };

        // --- DOM Elements ---
        const els = {
            body: document.body,
            themeToggle: document.getElementById('theme-toggle'),
            themeIcon: document.getElementById('theme-icon'),
            uploadArea: document.getElementById('upload-area'),
            fileInput: document.getElementById('file-input'),

            // Pills
            pillKeyword: document.getElementById('pill-keyword'),
            pillH1: document.getElementById('pill-h1'),
            pillTopic: document.getElementById('pill-topic'),
            btnKeyword: document.getElementById('btn-keyword-apply'),
            btnH1: document.getElementById('btn-h1-apply'),
            btnTopic: document.getElementById('btn-topic-apply'),

            // Badges
            badgeKeyword: document.getElementById('badge-keyword'),
            badgeH1: document.getElementById('badge-h1'),
            badgeTopic: document.getElementById('badge-topic'),

            copyBtn: document.getElementById('copy-btn'),
            tabsContainer: document.getElementById('tabs-container'),
            tabsWrapper: document.getElementById('prompt-tabs-wrapper'),
            promptTitle: document.getElementById('prompt-title'),
            promptSubtitle: document.getElementById('prompt-subtitle'),
            emptyState: document.getElementById('empty-state'),
            contentWrapper: document.getElementById('prompt-content-wrapper'),
            promptContent: document.getElementById('prompt-content'),
            brandRow: document.getElementById('brand-row'),
            promptsRow: document.getElementById('prompts-row'),
            brandStatusInd: document.getElementById('brand-status-indicator'),
            promptsStatusInd: document.getElementById('prompts-status-indicator'),

            // Auto Load Button
            autoLoadBtn: document.getElementById('auto-load-btn'),

            // Rules Modal
            rulesBtn: document.getElementById('rules-btn'),
            rulesModal: document.getElementById('rules-modal'),
            rulesModalBackdrop: document.getElementById('rules-modal-backdrop'),
            rulesModalPanel: document.getElementById('rules-modal-panel'),
            rulesCloseBtn: document.getElementById('rules-close-btn'),

            // CTA Modal
            ctaModalBtn: document.getElementById('cta-parser-btn'),
            ctaModal: document.getElementById('cta-modal'),
            ctaModalBackdrop: document.getElementById('cta-modal-backdrop'),
            ctaModalPanel: document.getElementById('cta-modal-panel'),
            ctaCloseBtn: document.getElementById('cta-close-btn'),
            ctaProcessBtn: document.getElementById('cta-process-btn'),
            ctaInput: document.getElementById('cta-input'),
            ctaResultsContainer: document.getElementById('cta-results-container'),
            ctaResetBtn: document.getElementById('cta-reset-btn'),
            ctaClearBtn: document.getElementById('cta-clear-btn'),
            ctaEmptyState: document.getElementById('cta-empty-state'),
            ctaStatus: document.getElementById('cta-status'),
            ctaLineCount: document.getElementById('cta-line-count'),
            ctaResultCount: document.getElementById('cta-result-count'),
            ctaCopyAllBtn: document.getElementById('cta-copy-all-btn'),

            // Changes Modal
            changesModalBtn: document.getElementById('changes-parser-btn'),
            changesModal: document.getElementById('changes-modal'),
            changesModalBackdrop: document.getElementById('changes-modal-backdrop'),
            changesModalPanel: document.getElementById('changes-modal-panel'),
            changesCloseBtn: document.getElementById('changes-close-btn'),
            changesInput: document.getElementById('changes-input'),
            changesParseBtn: document.getElementById('changes-parse-btn'),
            changesClearBtn: document.getElementById('changes-clear-btn'),
            changesResetBtn: document.getElementById('changes-reset-btn'),
            changesResultsContainer: document.getElementById('changes-results-container'),
            changesEmptyState: document.getElementById('changes-empty-state'),
            changesStatus: document.getElementById('changes-status'),
            changesLineCount: document.getElementById('changes-line-count'),
            changesResultCount: document.getElementById('changes-result-count'),
            changesCopyAllBtn: document.getElementById('changes-copy-all-btn'),

            // Toast
            toast: document.getElementById('toast')
        };

        // --- Theme Logic ---
        function initTheme() {
            const saved = localStorage.getItem('gxc-theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (!saved && systemDark)) applyTheme(true);
            else applyTheme(false);
        }

        function applyTheme(isDark) {
            state.isDark = isDark;
            if (isDark) {
                document.documentElement.classList.add('dark');
                els.themeIcon.classList.remove('fa-moon');
                els.themeIcon.classList.add('fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                els.themeIcon.classList.remove('fa-sun');
                els.themeIcon.classList.add('fa-moon');
            }
            localStorage.setItem('gxc-theme', isDark ? 'dark' : 'light');
        }

        els.themeToggle.addEventListener('click', () => applyTheme(!state.isDark));

        // --- Animation Utilities ---
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function smoothContentSwap(contentUpdater) {
            if (!els.contentWrapper.classList.contains('hidden')) {
                els.contentWrapper.style.opacity = '0';
                els.promptContent.style.transform = 'translateY(5px)';
                await wait(200);
            }
            contentUpdater();
            els.emptyState.classList.add('hidden');
            els.contentWrapper.classList.remove('hidden');
            void els.contentWrapper.offsetWidth; // Reflow
            els.contentWrapper.style.opacity = '1';
            els.promptContent.style.transform = 'translateY(0)';
        }

        function updateStatusUI(type, status, message) {
            let row, indicator, textEl;

            if (type === 'brand') {
                row = els.brandRow;
                indicator = els.brandStatusInd;
                textEl = row.querySelector('.status-text');
            } else {
                row = els.promptsRow;
                indicator = els.promptsStatusInd;
                textEl = row.querySelector('.status-text');
            }

            const colorClass = status === 'success' ? 'text-green-600 dark:text-green-400' : 'text-gray-400';
            const bgClass = status === 'success'
                ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800/50'
                : 'bg-gray-50 dark:bg-gray-800/50 border-transparent';

            const dotClass = status === 'success' ? 'bg-green-500' : 'bg-gray-300';

            textEl.className = `status-text text-sm font-semibold transition-colors ${colorClass}`;
            textEl.textContent = message;
            row.className = `flex items-center justify-between p-2 rounded-xl border transition-all duration-300 ${bgClass}`;
            indicator.className = `w-2 h-2 rounded-full transition-colors ${dotClass}`;
        }

        // --- Shared Logic: Process a file's content based on its filename ---
        function handleFileContent(filename, content) {
            const name = filename.toLowerCase();

            // Brand Rules Check
            if (name.includes('brand') && name.includes('rules')) {
                state.brandRules = content;
                updateStatusUI('brand', 'success', 'Loaded');
                return true; // Updated
            }

            // Prompt Check
            const match = name.match(/prompt\s*(\d)/i);
            if (match) {
                const num = parseInt(match[1]);
                if (num >= 1 && num <= 7) {
                    state.prompts[num] = content;
                    return true; // Updated
                }
            }
            return false;
        }

        // --- Core Logic: Drag & Drop ---
        function processFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    handleFileContent(file.name, content);

                    const loadedCount = Object.values(state.prompts).filter(p => p !== '').length;
                    updateStatusUI('prompts', loadedCount > 0 ? 'success' : 'default', `${loadedCount}/7 Loaded`);

                    if (state.brandRules && loadedCount > 0) {
                        initializeInterface();
                    }
                };
                reader.readAsText(file);
            });
        }

        // --- GitHub Auto Load Logic ---
        async function loadFromGitHub() {
            const icon = els.autoLoadBtn.querySelector('i');
            const originalClass = icon.className;
            icon.className = "fas fa-spinner fa-spin text-lg";

            const urls = [
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/BRAND%20%26%20CONTENT%20RULES.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%201.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%202.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%203.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%204.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%205.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%206.txt',
                'https://raw.githubusercontent.com/Mahmudul-Hasan-Shawon/Content-Proofreading-Maven/refs/heads/main/PROMPT%207.txt'
            ];

            let successCount = 0;
            let failCount = 0;

            for (const url of urls) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Failed to fetch ${url}: ${response.status}`);
                        failCount++;
                    } else {
                        const text = await response.text();

                        const filename = decodeURIComponent(url.split('/').pop());

                        handleFileContent(filename, text);
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Error fetching ${url}:`, error);
                    failCount++;
                }
            }

            // Update UI State
            const loadedCount = Object.values(state.prompts).filter(p => p !== '').length;
            updateStatusUI('prompts', loadedCount > 0 ? 'success' : 'default', `${loadedCount}/7 Loaded`);

            if (state.brandRules && loadedCount > 0) {
                initializeInterface();
            }

            // Reset Button & Feedback
            icon.className = originalClass;

            if (failCount > 0) {
                showToast(`Loaded ${successCount} files. Failed: ${failCount}`, true);
            } else {
                showToast("All files loaded from GitHub!");
            }
        }

        function showToast(msg, isError = false) {
            els.toast.textContent = msg;
            if (isError) els.toast.classList.add('error');
            else els.toast.classList.remove('error');

            els.toast.className = "show";
            setTimeout(() => { els.toast.className = els.toast.className.replace("show", ""); }, 3000);
        }

        function initializeInterface() {
            els.tabsContainer.classList.remove('hidden');
            els.tabsContainer.classList.add('animate-fade-in');
            renderTabs();
            const firstAvailable = Object.keys(state.prompts).find(key => state.prompts[key]);
            if (firstAvailable && state.currentPromptIndex === 0) {
                selectPrompt(parseInt(firstAvailable));
            }
        }

        function renderTabs() {
            els.tabsWrapper.innerHTML = '';
            for (let i = 1; i <= 7; i++) {
                const isLoaded = state.prompts[i] !== '';
                const btn = document.createElement('button');
                const isActive = state.currentPromptIndex === i;

                btn.className = `prompt-tab group px-4 py-2 rounded-xl text-xs font-semibold whitespace-nowrap flex flex-row items-center justify-center gap-2 transition-all duration-300
                    ${isActive
                        ? 'active text-white'
                        : isLoaded
                            ? 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700/50'
                            : 'opacity-30 cursor-not-allowed bg-gray-50 dark:bg-gray-800/30 text-gray-400'}`;

                btn.innerHTML = `<span class="opacity-70">#${i}</span>${state.promptTitles[i]}`;

                if (isLoaded) {
                    btn.onclick = () => selectPrompt(i);
                }
                els.tabsWrapper.appendChild(btn);
            }
        }

        // --- Replacement Logic ---
        function processText(text) {
            let processed = text;
            if (state.variables.keyword) {
                processed = processed.replace(/\[(?:ENTER\s+)?TARGET\s+KEYWORD\]/gi, state.variables.keyword);
            }
            if (state.variables.h1) {
                processed = processed.replace(/\[ENTER\s+H1\]/gi, state.variables.h1);
            }
            if (state.variables.topic) {
                processed = processed.replace(/\[ARTICLE\s+TOPICS\]/gi, state.variables.topic);
            }
            return processed;
        }

        function generatePrompt(index) {
            let rawPrompt = state.prompts[index].replace(/\[Paste Brand Voice Block first\]\s*/gi, '');
            if (index === 6) {
                return processText(rawPrompt);
            }
            const combined = `${state.brandRules}\n\n${rawPrompt}`;
            return processText(combined);
        }

        function selectPrompt(index) {
            if (!state.prompts[index]) return;
            state.currentPromptIndex = index;
            renderTabs();

            const fullPrompt = generatePrompt(index);

            els.promptTitle.textContent = `Prompt ${index}: ${state.promptTitles[index]}`;

            if (index === 6) {
                els.promptSubtitle.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Brand Rules Excluded`;
            } else {
                els.promptSubtitle.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Ready to copy`;
            }

            els.copyBtn.disabled = false;

            toggleBadge(els.badgeKeyword, state.variables.keyword);
            toggleBadge(els.badgeH1, state.variables.h1);
            toggleBadge(els.badgeTopic, state.variables.topic);

            smoothContentSwap(() => {
                els.promptContent.innerHTML = escapeHtml(fullPrompt);
                highlightVariables();
            });
        }

        function toggleBadge(el, isActive) {
            if (isActive) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        }

        function highlightVariables() {
            let html = els.promptContent.innerHTML;

            if (state.variables.keyword) {
                const safeK = state.variables.keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const kRegex = new RegExp(`(${safeK})`, 'gi');
                html = html.replace(kRegex, '<span class="keyword-highlight">$1</span>');
            }

            if (state.variables.h1) {
                const safeH = state.variables.h1.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const hRegex = new RegExp(`(${safeH})`, 'gi');
                html = html.replace(hRegex, '<span class="h1-highlight">$1</span>');
            }

            if (state.variables.topic) {
                const safeT = state.variables.topic.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const tRegex = new RegExp(`(${safeT})`, 'gi');
                html = html.replace(tRegex, '<span class="topic-highlight">$1</span>');
            }

            els.promptContent.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Variable Actions ---
        function applyVariable(type) {
            const input = type === 'keyword' ? els.pillKeyword : (type === 'h1' ? els.pillH1 : els.pillTopic);
            const val = input.value.trim();
            const btn = type === 'keyword' ? els.btnKeyword : (type === 'h1' ? els.btnH1 : els.btnTopic);

            if (!val) {
                input.parentElement.classList.add('ring-2', 'ring-red-400', 'ring-opacity-50');
                setTimeout(() => input.parentElement.classList.remove('ring-2', 'ring-red-400', 'ring-opacity-50'), 500);
                return;
            }

            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin text-xs"></i>`;

            setTimeout(() => {
                state.variables[type] = val;

                btn.innerHTML = `<i class="fas fa-check text-xs"></i>`;
                btn.classList.add('active');
                setTimeout(() => {
                    btn.classList.remove('active');
                    btn.innerHTML = originalIcon;
                }, 1500);

                if (state.currentPromptIndex > 0) {
                    selectPrompt(state.currentPromptIndex);
                }
            }, 300);
        }

        // --- Rules Modal Logic ---
        function openRulesModal() {
            els.rulesModal.classList.remove('hidden');
            setTimeout(() => {
                els.rulesModalBackdrop.classList.remove('opacity-0');
                els.rulesModalPanel.classList.remove('scale-95', 'opacity-0');
                els.rulesModalPanel.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeRulesModal() {
            els.rulesModalBackdrop.classList.add('opacity-0');
            els.rulesModalPanel.classList.remove('scale-100', 'opacity-100');
            els.rulesModalPanel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                els.rulesModal.classList.add('hidden');
            }, 300);
        }

        // --- CTA Parser Modal Logic ---
        function openCtaModal() {
            els.ctaModal.classList.remove('hidden');
            setTimeout(() => {
                els.ctaModalBackdrop.classList.remove('opacity-0');
                els.ctaModalPanel.classList.remove('scale-95', 'opacity-0');
                els.ctaModalPanel.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeCtaModal() {
            els.ctaModalBackdrop.classList.add('opacity-0');
            els.ctaModalPanel.classList.remove('scale-100', 'opacity-100');
            els.ctaModalPanel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                els.ctaModal.classList.add('hidden');
            }, 300);
        }

        function resetCtaParser() {
            els.ctaInput.value = '';
            els.ctaResultsContainer.innerHTML = '';
            els.ctaEmptyState.classList.remove('hidden');
            els.ctaResultCount.textContent = `0 CTAs`;
            els.ctaResultCount.className = 'text-[10px] font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 px-2 py-0.5 rounded-md';
            state.ctaCopiedItems = {};
            showCtaStatus('Ready', 'default');
            updateCtaLineCount();
        }

        function processCTA() {
            const text = els.ctaInput.value.trim();
            if (!text) {
                showCtaStatus('Please paste text first', 'error');
                return;
            }

            showCtaStatus('Parsing...', 'info');
            els.ctaResultsContainer.innerHTML = '';
            els.ctaEmptyState.classList.add('hidden');

            const lines = text.split('\n');
            const ctas = [];
            state.ctaCopiedItems = {}; // Reset copy state

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.toLowerCase().startsWith('cta:')) {
                    const match = line.match(/\*\*(.*?)\*\*/);
                    if (match && match[1]) {
                        ctas.push(match[1]);
                        // CTA parser only has one "copy" action per card, so we track simple bool or just rely on UI state
                        state.ctaCopiedItems[ctas.length] = false;
                    }
                }
            }

            if (ctas.length === 0) {
                els.ctaEmptyState.classList.remove('hidden');
                showCtaStatus('No CTAs found', 'warning');
                els.ctaResultCount.textContent = `0 CTAs`;
                els.ctaResultCount.className = 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400 px-2 py-0.5 rounded-md';
            } else {
                displayCtaCards(ctas);
                showCtaStatus(`Found ${ctas.length} CTAs`, 'success');
                els.ctaResultCount.textContent = `${ctas.length} CTAs`;
                els.ctaResultCount.className = 'text-[10px] font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 px-2 py-0.5 rounded-md';
            }
        }

        function displayCtaCards(ctas) {
            ctas.forEach((cta, index) => {
                const cardId = index + 1; // Starts from CTA #1
                const card = document.createElement('div');
                card.id = `cta-card-${cardId}`;
                card.className = 'parser-card-item bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm';

                card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-md bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 border border-indigo-200 dark:border-indigo-800">CTA #${cardId}</span>
                <button onclick="handleCtaCopy(${cardId}, this)" class="btn-progress-container w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 flex items-center justify-center transition" title="Copy CTA">
                    <i class="fas fa-copy text-xs btn-icon"></i>
                    <div class="btn-progress-line"></div>
                </button>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-200 font-bold dark:border-gray-700 card-text">${cta}</div>
        `;
                els.ctaResultsContainer.appendChild(card);
            });
        }

        async function handleCtaCopy(cardId, btnElement) {
            const card = document.getElementById(`cta-card-${cardId}`);
            let text = card.querySelector('.card-text').textContent;

            // Format the text: remove spaces after periods
            text = text.replace(/\.\s+/g, '.');

            // Add a single space after periods (but not multiple spaces)
            // This ensures proper spacing without extra spaces
            text = text.replace(/\.([^\s])/g, '. $1');

            // Animation Start
            btnElement.classList.add('loading');
            const progressBar = btnElement.querySelector('.btn-progress-line');
            progressBar.style.width = '0%';

            // Simulate loading/progress
            setTimeout(() => { progressBar.style.width = '50%'; }, 50);
            setTimeout(() => { progressBar.style.width = '100%'; }, 150);

            try {
                // Try to copy as rich text (HTML) for proper bold formatting
                const htmlContent = `<strong>${text}</strong>`;
                const plainContent = text; // Fallback plain text

                try {
                    // Create ClipboardItem with both HTML and plain text formats
                    const htmlBlob = new Blob([htmlContent], { type: 'text/html' });
                    const plainBlob = new Blob([plainContent], { type: 'text/plain' });

                    const clipboardItem = new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': plainBlob
                    });

                    await navigator.clipboard.write([clipboardItem]);

                } catch (clipboardApiError) {
                    // Fallback: copy plain text without bold formatting
                    console.log('Using fallback copy method');
                    await navigator.clipboard.writeText(plainContent);
                }

                state.ctaCopiedItems[cardId] = true;

                // Finish Animation
                setTimeout(() => {
                    btnElement.classList.remove('loading');
                    progressBar.style.width = '0%'; // Reset

                    // Change icon to check temporarily
                    btnElement.innerHTML = `<i class="fas fa-check text-xs text-green-600"></i>`;
                    setTimeout(() => {
                        btnElement.innerHTML = `<i class="fas fa-copy text-xs btn-icon"></i><div class="btn-progress-line"></div>`;
                    }, 1500);
                }, 300);

                showCtaStatus('Copied with bold formatting!', 'success');
            } catch (err) {
                console.error(err);
                btnElement.classList.remove('loading');
                progressBar.style.width = '0%';
                showCtaStatus('Failed to copy', 'error');
            }
        }

        async function copyAllCta() {
            const cards = document.querySelectorAll('[id^="cta-card-"]');
            if (cards.length === 0) return;

            const originalHTML = els.ctaCopyAllBtn.innerHTML;
            els.ctaCopyAllBtn.innerHTML = `
                <span class="flex flex-col items-center w-full">
                    <span>Copying...</span>
                    <div class="btn-progress-bg btn-copy-progress mt-1"><div class="btn-progress-line" style="width: 0%"></div></div>
                </span>
            `;
            const fill = els.ctaCopyAllBtn.querySelector('.btn-progress-line');

            setTimeout(() => { fill.style.width = '40%'; }, 50);
            setTimeout(() => { fill.style.width = '80%'; }, 200);

            const texts = [];
            cards.forEach(card => {
                texts.push(card.querySelector('.card-text').textContent);
            });

            const finalText = texts.join('\n\n');

            try {
                await navigator.clipboard.writeText(finalText);
                setTimeout(() => { fill.style.width = '100%'; }, 400);

                setTimeout(() => {
                    els.ctaCopyAllBtn.innerHTML = `<span>Copied!</span>`;
                    showCtaStatus('All CTAs copied', 'success');
                    setTimeout(() => {
                        els.ctaCopyAllBtn.innerHTML = `<span>Copy All</span>`;
                    }, 2000);
                }, 500);
            } catch (err) {
                console.error(err);
                els.ctaCopyAllBtn.innerHTML = originalHTML;
                showCtaStatus('Copy failed', 'error');
            }
        }

        function updateCtaLineCount() {
            const lines = els.ctaInput.value.split('\n').length;
            els.ctaLineCount.textContent = `${lines} lines`;
        }

        function showCtaStatus(msg, type) {
            els.ctaStatus.textContent = msg;
            els.ctaStatus.className = 'text-xs px-3 py-1 rounded-xl transition-colors duration-200 ';
            if (type === 'success') els.ctaStatus.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') els.ctaStatus.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'warning') els.ctaStatus.classList.add('bg-yellow-100', 'text-yellow-800');
            else els.ctaStatus.classList.add('bg-gray-100', 'text-gray-600');
        }


        // --- CHANGES PARSER LOGIC ---

        function updateChangesLineCount() {
            const lines = els.changesInput.value.split('\n').length;
            els.changesLineCount.textContent = `${lines} lines`;
        }

        function openChangesModal() {
            els.changesModal.classList.remove('hidden');
            setTimeout(() => {
                els.changesModalBackdrop.classList.remove('opacity-0');
                els.changesModalPanel.classList.remove('scale-95', 'opacity-0');
                els.changesModalPanel.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeChangesModal() {
            els.changesModalBackdrop.classList.add('opacity-0');
            els.changesModalPanel.classList.remove('scale-100', 'opacity-100');
            els.changesModalPanel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                els.changesModal.classList.add('hidden');
            }, 300);
        }

        function resetChanges() {
            els.changesInput.value = '';
            els.changesResultsContainer.innerHTML = '';
            els.changesEmptyState.classList.remove('hidden');
            els.changesResultCount.textContent = `0 items`;
            els.changesResultCount.className = 'text-[10px] font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-0.5 rounded-md';
            state.changesCopiedItems = {};
            showChangesStatus('Ready', 'default');
            updateChangesLineCount();
        }

        function parseChangesText() {
            const text = els.changesInput.value.trim();
            if (!text) {
                showChangesStatus('Please paste text first', 'error');
                return;
            }

            showChangesStatus('Parsing...', 'info');
            els.changesResultsContainer.innerHTML = '';
            els.changesEmptyState.classList.add('hidden');

            const lines = text.split('\n');
            let currentSection = 'H1'; // Default starts at H1
            const changes = [];
            state.changesCopiedItems = {}; // Reset copy state

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.includes('H1:')) currentSection = 'H1';
                else if (line.includes('H2s:')) currentSection = 'H2';
                else if (line.includes('H3s:')) currentSection = 'H3';

                if (line.startsWith('CHANGED:')) {
                    const change = parseChangedLine(line, currentSection);
                    if (change) {
                        changes.push(change);
                        state.changesCopiedItems[changes.length] = { original: false, changed: false };
                    }
                }
            }

            if (changes.length === 0) {
                els.changesEmptyState.classList.remove('hidden');
                showChangesStatus('No changes found', 'warning');
                els.changesResultCount.textContent = `0 items`;
                els.changesResultCount.className = 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400 px-2 py-0.5 rounded-md';
            } else {
                displayChangesCards(changes);
                showChangesStatus(`Found ${changes.length} items`, 'success');
                els.changesResultCount.textContent = `${changes.length} items`;
                els.changesResultCount.className = 'text-[10px] font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-0.5 rounded-md';
            }
        }

        function parseChangedLine(line, section) {
            const regex = /CHANGED:\s*"([^"]+)"\s*\s*"([^"]+)"\s*\(([^)]+)\)/;
            const match = line.match(regex);
            if (match) {
                return {
                    section: section,
                    original: match[1],
                    changed: match[2],
                    reason: match[3].trim()
                };
            }
            return null;
        }

        function displayChangesCards(changes) {
    changes.forEach((change, index) => {
        const cardId = index + 1;
        const card = document.createElement('div');
        card.id = `card-${cardId}`;
        card.className = 'parser-card-item bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm';

        // Always show "Parser #X" based on card position
        const badgeText = `CHANGES #${cardId}`;
        
        // You can keep color coding based on section if you want
        let badgeClass = '';
        if (change.section === 'H1') {
            badgeClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border border-blue-200 dark:border-blue-800';
        } else if (change.section === 'H2') {
            badgeClass = 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800';
        } else {
            badgeClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 border border-purple-200 dark:border-purple-800';
        }

        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-md ${badgeClass}">${badgeText}</span>
                <div class="flex gap-2">
                    <button onclick="handleChangesCopy(${cardId}, 'original', this)" class="btn-progress-container w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 flex items-center justify-center transition" title="Copy Original">
                        <i class="fas fa-copy text-xs btn-icon"></i>
                        <div class="btn-progress-line"></div>
                    </button>
                    <button onclick="handleChangesCopy(${cardId}, 'changed', this)" class="btn-progress-container w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 hover:text-green-700 dark:hover:text-green-400 flex items-center justify-center transition" title="Copy Changed">
                        <i class="fas fa-check text-xs btn-icon"></i>
                        <div class="btn-progress-line"></div>
                    </button>
                </div>
            </div>
            
            <div class="space-y-2">
                <div class="group relative">
                    <div class="text-[10px] uppercase text-gray-400 font-bold mb-1 card-text">Original</div>
                    <div class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-200 dark:border-gray-700 card-text">${change.original}</div>
                </div>
                <div class="group relative">
                    <div class="text-[10px] uppercase text-green-600 dark:text-green-400 font-bold mb-1 card-text">Changed To</div>
                    <div class="text-sm text-green-800 dark:text-green-300 bg-green-50 dark:bg-green-900/20 p-3 rounded-xl border border-green-200 dark:border-green-800 card-text">${change.changed}</div>
                </div>
            </div>
            
            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 p-2 rounded-xl flex items-start gap-2">
                <i class="fas fa-info-circle mt-0.5 text-gray-400 card-text"></i>
                <span class="card-text">${change.reason}</span>
            </div>
        `;
        els.changesResultsContainer.appendChild(card);
    });
}

        async function handleChangesCopy(cardId, type, btnElement) {
            const card = document.getElementById(`card-${cardId}`);
            const isOriginal = type === 'original';

            // Select text based on type
            const textElements = card.querySelectorAll('.card-text');
            // Original text is the second card-text child (inside the first group)
            // Changed text is the fourth card-text child (inside the second group)
            const text = isOriginal ? textElements[1].textContent : textElements[3].textContent;

            // Animation Start
            btnElement.classList.add('loading');
            const progressBar = btnElement.querySelector('.btn-progress-line');
            progressBar.style.width = '0%';

            // Simulate loading/progress
            setTimeout(() => { progressBar.style.width = '50%'; }, 50);
            setTimeout(() => { progressBar.style.width = '100%'; }, 150);

            try {
                await navigator.clipboard.writeText(text);

                // Update State
                if (!state.changesCopiedItems[cardId]) state.changesCopiedItems[cardId] = { original: false, changed: false };
                state.changesCopiedItems[cardId][type] = true;

                // Check if both copied -> Turn Soft Red
                if (state.changesCopiedItems[cardId].original && state.changesCopiedItems[cardId].changed) {
                    card.classList.add('card-copied-fully');
                }

                // Finish Animation
                setTimeout(() => {
                    btnElement.classList.remove('loading');
                    progressBar.style.width = '0%';

                    // Change icon to check temporarily
                    btnElement.innerHTML = `<i class="fas fa-check text-xs text-green-600"></i>`;
                    setTimeout(() => {
                        // Reset to original icon structure
                        const iconClass = isOriginal ? 'fa-copy' : 'fa-check';
                        btnElement.innerHTML = `<i class="fas ${iconClass} text-xs btn-icon"></i><div class="btn-progress-line"></div>`;
                    }, 1500);
                }, 300);

                showChangesStatus('Copied!', 'success');
            } catch (err) {
                console.error(err);
                btnElement.classList.remove('loading');
                progressBar.style.width = '0%';
                showChangesStatus('Failed to copy', 'error');
            }
        }

        async function copyAllChanges() {
            const cards = document.querySelectorAll('[id^="card-"]');
            if (cards.length === 0) return;

            const originalHTML = els.changesCopyAllBtn.innerHTML;
            els.changesCopyAllBtn.innerHTML = `
                <span class="flex flex-col items-center w-full">
                    <span>Copying...</span>
                    <div class="btn-progress-bg btn-copy-progress mt-1"><div class="btn-progress-line" style="width: 0%"></div></div>
                </span>
            `;
            const fill = els.changesCopyAllBtn.querySelector('.btn-progress-line');

            // Simulate progress (500ms total)
            setTimeout(() => { fill.style.width = '40%'; }, 50);
            setTimeout(() => { fill.style.width = '80%'; }, 200);

            const texts = [];
            // Collect all "Changed" text (standard workflow is to copy the new version)
            cards.forEach(card => {
                const textElements = card.querySelectorAll('.card-text');
                // Changed text is index 3 (0:Label, 1:OrigVal, 2:Label, 3:ChangeVal)
                if (textElements[3]) {
                    texts.push(textElements[3].textContent);
                }
            });

            const finalText = texts.join('\n\n');

            try {
                await navigator.clipboard.writeText(finalText);
                setTimeout(() => { fill.style.width = '100%'; }, 400);

                setTimeout(() => {
                    els.changesCopyAllBtn.innerHTML = `<span>Copied!</span>`;
                    showChangesStatus('All changed items copied', 'success');
                    setTimeout(() => {
                        els.changesCopyAllBtn.innerHTML = `<span>Copy All</span>`;
                    }, 2000);
                }, 500);
            } catch (err) {
                console.error(err);
                els.changesCopyAllBtn.innerHTML = originalHTML;
                showChangesStatus('Copy failed', 'error');
            }
        }

        function showChangesStatus(msg, type) {
            els.changesStatus.textContent = msg;
            els.changesStatus.className = 'text-xs px-3 py-1 rounded-xl transition-colors duration-200 ';
            if (type === 'success') els.changesStatus.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') els.changesStatus.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'warning') els.changesStatus.classList.add('bg-yellow-100', 'text-yellow-800');
            else els.changesStatus.classList.add('bg-gray-100', 'text-gray-600');
        }

        // --- Event Listeners ---

        // Auto Load Listener
        els.autoLoadBtn.addEventListener('click', loadFromGitHub);

        [els.pillKeyword, els.pillH1, els.pillTopic].forEach(input => {
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    if (input === els.pillKeyword) applyVariable('keyword');
                    else if (input === els.pillH1) applyVariable('h1');
                    else applyVariable('topic');
                }
            });
        });

        els.btnKeyword.addEventListener('click', () => applyVariable('keyword'));
        els.btnH1.addEventListener('click', () => applyVariable('h1'));
        els.btnTopic.addEventListener('click', () => applyVariable('topic'));

        els.uploadArea.addEventListener('click', () => els.fileInput.click());
        els.fileInput.addEventListener('change', (e) => processFiles(e.target.files));

        els.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            els.uploadArea.classList.add('dragover');
        });

        els.uploadArea.addEventListener('dragleave', () => els.uploadArea.classList.remove('dragover'));

        els.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            els.uploadArea.classList.remove('dragover');
            processFiles(e.dataTransfer.files);
        });

        els.copyBtn.addEventListener('click', () => {
            const text = generatePrompt(state.currentPromptIndex);

            navigator.clipboard.writeText(text).then(() => {
                const original = els.copyBtn.innerHTML;
                els.copyBtn.innerHTML = `<i class="fas fa-check"></i> Copied!`;
                setTimeout(() => {
                    els.copyBtn.innerHTML = original;
                }, 2000);
            });
        });

        // Rules Modal Listeners
        els.rulesBtn.addEventListener('click', openRulesModal);
        els.rulesCloseBtn.addEventListener('click', closeRulesModal);
        els.rulesModalBackdrop.addEventListener('click', closeRulesModal);

        // CTA Modal Listeners
        els.ctaModalBtn.addEventListener('click', openCtaModal);
        els.ctaCloseBtn.addEventListener('click', closeCtaModal);
        els.ctaModalBackdrop.addEventListener('click', closeCtaModal);
        els.ctaProcessBtn.addEventListener('click', processCTA);
        els.ctaResetBtn.addEventListener('click', resetCtaParser);
        els.ctaCopyAllBtn.addEventListener('click', copyAllCta);
        els.ctaInput.addEventListener('input', updateCtaLineCount);

        // Changes Modal Listeners
        els.changesModalBtn.addEventListener('click', openChangesModal);
        els.changesCloseBtn.addEventListener('click', closeChangesModal);
        els.changesModalBackdrop.addEventListener('click', closeChangesModal);
        els.changesParseBtn.addEventListener('click', parseChangesText);
        els.changesClearBtn.addEventListener('click', () => {
            els.changesInput.value = '';
        });
        els.changesResetBtn.addEventListener('click', resetChanges);
        els.changesCopyAllBtn.addEventListener('click', copyAllChanges);
        els.changesInput.addEventListener('input', updateChangesLineCount);

        // Init
        initTheme();

    </script>
</body>

</html>